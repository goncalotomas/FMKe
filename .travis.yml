sudo: true
dist: trusty
language: erlang
otp_release:
  - 20.3
  - 21.1
services:
  - docker
install:
  - rebar3 local upgrade
  - chmod u+x /home/travis/.cache/rebar3/bin/rebar3
  - cp /home/travis/.cache/rebar3/bin/rebar3 /usr/local/bin/
  - make all
  - rebar3 xref
  - rebar3 dialyzer
  - rebar3 as lint lint
before_script:
  - epmd -daemon
  - sudo sh -c 'echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6'
  - echo "deb http://us.archive.ubuntu.com/ubuntu/ xenial main" | sudo tee -a /etc/apt/sources.list
  - echo "deb http://us.archive.ubuntu.com/ubuntu/ xenial universe" | sudo tee -a /etc/apt/sources.list
  - echo "deb http://us.archive.ubuntu.com/ubuntu/ xenial-updates universe" | sudo tee -a /etc/apt/sources.list
  - echo "deb http://us.archive.ubuntu.com/ubuntu/ xenial-updates multiverse" | sudo tee -a /etc/apt/sources.list
  - echo "deb http://security.ubuntu.com/ubuntu xenial-security main" | sudo tee -a /etc/apt/sources.list
  - echo "deb http://security.ubuntu.com/ubuntu xenial-security multiverse" | sudo tee -a /etc/apt/sources.list
  - sudo apt-get update -qq
  - sudo apt-get install libuv1-dev g++ make cmake libssl-dev
script:
  - rebar3 eunit
  - rebar3 ct
  - rebar3 ct --suite fmke_core_unit_test_SUITE.erl --config test/fmke_configs/antidote_non_nested_data_model.config --cover --cover_export_name=core_antidote_non_nested_opt
  - rebar3 ct --suite fmke_core_unit_test_SUITE.erl --config test/fmke_configs/cassandra_non_nested_data_model.config --cover --cover_export_name=core_cassandra_non_nested_opt
  - rebar3 ct --suite fmke_core_unit_test_SUITE.erl --config test/fmke_configs/ets_nested_data_model.config --cover --cover_export_name=core_ets_nested
  - rebar3 ct --suite fmke_core_unit_test_SUITE.erl --config test/fmke_configs/ets_non_nested_data_model.config --cover --cover_export_name=core_ets_non_nested
  - rebar3 ct --suite fmke_core_unit_test_SUITE.erl --config test/fmke_configs/redis_non_nested_data_model.config --cover --cover_export_name=core_redis_non_nested_opt
  - rebar3 ct --suite fmke_core_unit_test_SUITE.erl --config test/fmke_configs/riak_non_nested_data_model.config --cover --cover_export_name=core_riak_non_nested_opt
  - rebar3 ct --suite fmke_http_api_SUITE.erl --config test/fmke_configs/antidote_non_nested_data_model.config --cover --cover_export_name=http_antidote_non_nested_opt
  - rebar3 ct --suite fmke_http_api_SUITE.erl --config test/fmke_configs/cassandra_non_nested_data_model.config --cover --cover_export_name=http_cassandra_non_nested_opt
  - rebar3 ct --suite fmke_http_api_SUITE.erl --config test/fmke_configs/ets_nested_data_model.config --cover --cover_export_name=http_ets_nested
  - rebar3 ct --suite fmke_http_api_SUITE.erl --config test/fmke_configs/ets_non_nested_data_model.config --cover --cover_export_name=http_ets_non_nested
  - rebar3 ct --suite fmke_http_api_SUITE.erl --config test/fmke_configs/redis_non_nested_data_model.config --cover --cover_export_name=http_redis_non_nested_opt
  - rebar3 ct --suite fmke_http_api_SUITE.erl --config test/fmke_configs/riak_non_nested_data_model.config --cover --cover_export_name=http_riak_non_nested_opt
  - rebar3 as test coveralls send
  # - make bench
after_failure:
  - cat /home/travis/build/goncalotomas/FMKe/_build/test/logs/ct.latest.log
  - cat /home/travis/build/goncalotomas/FMKe/_build/test/logs/*/log/console.log
  - cat /home/travis/build/goncalotomas/FMKe/_build/test/logs/*/log/crash.log
  - cat /home/travis/build/goncalotomas/FMKe/_build/test/logs/*/log/error.log
  - cat /home/travis/build/goncalotomas/FMKe/_build/test/logs/*/log/error.log
  - cat /home/travis/build/goncalotomas/FMKe/_build/test/logs/*/lib.fmke.logs/suite.log
cache:
  directories:
  - "$HOME/.cache/rebar3/hex/default"
